{% extends "base.html" %}

{% block title %}Команда · Командная Викторина{% endblock %}

{% block content %}
  {% set team = team or {} %}
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h1 class="h3 mb-4">Информация о команде</h1>
          <dl class="row">
            <dt class="col-sm-4">Название</dt>
            <dd class="col-sm-8">{{ team.name or "—" }}</dd>

            <dt class="col-sm-4">Код приглашения</dt>
            <dd class="col-sm-8">
              {% if team.code %}
                <span class="badge text-bg-primary fs-6">{{ team.code }}</span>
              {% else %}
                —
              {% endif %}
            </dd>

            <dt class="col-sm-4">Участники</dt>
            <dd class="col-sm-8">
              {% if team.members %}
                <ul class="list-group list-group-flush">
                  {% for member in team.members %}
                    <li class="list-group-item px-0">
                      <span class="fw-semibold">{{ member.name or member.username or "Без имени" }}</span>
                      {% if member.is_captain %}
                        <span class="badge text-bg-warning ms-2">Капитан</span>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted mb-0">Пока нет участников.</p>
              {% endif %}
            </dd>
          </dl>
        </div>
      </div>

      {% if user_is_captain %}
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h2 class="h4 mb-3">Управление игрой</h2>
            <form id="start-game-form" action="/team/start" method="post">
              <div class="mb-3">
                <label for="start-user" class="form-label">ID капитана</label>
                <input type="number" class="form-control" id="start-user" name="user_id" value="{{ captain_id }}" placeholder="Введите ID" required />
              </div>
              <input type="hidden" name="team_id" value="{{ team.id }}" />
              <button type="submit" class="btn btn-danger">Начать игру</button>
            </form>
            <div class="mt-3">
              <h3 class="h6 text-muted">Ответ сервера</h3>
              <pre class="bg-dark text-white p-3 rounded" id="start-game-response">Ожидание запроса…</pre>
            </div>
          </div>
        </div>
      {% endif %}

      {% if last_response %}
        <div class="alert alert-info" role="alert">
          <h2 class="h6 mb-2">Последний ответ API</h2>
          <pre class="mb-0">{{ last_response | tojson(indent=2) }}</pre>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if user_is_captain %}
    <script>
      const startGameForm = document.getElementById("start-game-form");
      const responseContainer = document.getElementById("start-game-response");

      if (startGameForm && responseContainer) {
        startGameForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          responseContainer.textContent = "Отправка запроса…";

          const formData = new FormData(startGameForm);
          const payload = {};
          formData.forEach((value, key) => {
            payload[key] = value;
          });

          try {
            const fetchResponse = await fetch(startGameForm.action, {
              method: startGameForm.method.toUpperCase(),
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const data = await fetchResponse.json();
            responseContainer.textContent = JSON.stringify(data, null, 2);
          } catch (error) {
            responseContainer.textContent = `Ошибка: ${error}`;
          }
        });
      }
    </script>
  {% endif %}
{% endblock %}
