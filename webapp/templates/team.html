{% extends "base.html" %}

{% block title %}–ö–æ–º–∞–Ω–¥–∞ ¬∑ –ö–æ–º–∞–Ω–¥–Ω–∞—è –í–∏–∫—Ç–æ—Ä–∏–Ω–∞{% endblock %}

{% block content %}
  {% set team = team or {} %}
  {% set match_info = match_status or {} %}
  {% set team_status_value = team.get('status') %}
  {% set team_completed_value = team.get('team_completed') %}
  {% set match_status_value = match_info.get('status') %}
  {% set match_team_status_value = match_info.get('team_status') %}
  {% set match_team_completed_value = match_info.get('team_completed') %}
  {% set team_finished = (team_status_value == 'finished') or team_completed_value %}
  {% if not team_finished and match_team_status_value == 'finished' %}
    {% set team_finished = True %}
  {% endif %}
  {% if not team_finished and match_team_completed_value %}
    {% set team_finished = True %}
  {% endif %}
  {% set match_finished = match_status_value == 'finished' %}
  <div class="row justify-content-center">
    <div class="col-lg-9 col-xl-8">
      <div id="match-summary-alert">
        {% if match_finished %}
          {% set result = match_info.result or {} %}
          {% set winner_name = result.winner_team_name or result.winnerTeamName %}
          {% set winner_score = result.winner_team_score if result.winner_team_score is not none else result.winnerTeamScore %}
          <div class="alert alert-success">
            <p class="mb-0">
              {% if winner_name and winner_score is not none %}
                ‚úÖ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–æ–º–∞–Ω–¥–∞ {{ winner_name }} –ø–æ–±–µ–¥–∏–ª–∞ —Å–æ —Å—á—ë—Ç–æ–º {{ winner_score }}.
              {% elif winner_name %}
                ‚úÖ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–æ–º–∞–Ω–¥–∞ {{ winner_name }} –ø–æ–±–µ–¥–∏–ª–∞.
              {% elif winner_score is not none %}
                ‚úÖ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–æ–±–µ–¥–Ω—ã–π —Å—á—ë—Ç: {{ winner_score }}.
              {% else %}
                ‚úÖ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.
              {% endif %}
              {% if match_info.results_url %}
                <a class="alert-link" href="{{ match_info.results_url }}">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</a>.
              {% endif %}
            </p>
          </div>
        {% elif team_finished %}
          <div class="alert alert-success">
            <p class="mb-0">üèÅ –í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞ –∏–≥—Ä—É. –û–∂–∏–¥–∞–µ–º –≤—Ç–æ—Ä—É—é –∫–æ–º–∞–Ω–¥—É‚Ä¶</p>
          </div>
        {% endif %}
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <header class="mb-4">
            <div class="d-flex flex-wrap align-items-baseline justify-content-between gap-3">
              <div>
                <h1 class="h4 mb-1">{{ team.name or (team.id and ('–ö–æ–º–∞–Ω–¥–∞ ' ~ team.id)) or '–ö–æ–º–∞–Ω–¥–∞' }}</h1>
                {% if team.code %}
                  <span class="badge text-bg-secondary">–ö–æ–¥: {{ team.code }}</span>
                {% endif %}
              </div>
              {% if user_is_captain %}
                <span class="badge text-bg-warning text-dark">–í—ã ‚Äî –∫–∞–ø–∏—Ç–∞–Ω</span>
              {% endif %}
            </div>
          </header>

          <section class="mb-4">
            <h2 class="h6 text-uppercase text-muted mb-2">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
            {% if team.members %}
              <ul class="list-unstyled mb-0">
                {% for member in team.members %}
                  <li class="d-flex align-items-center gap-2 py-1">
                    <span class="fw-semibold">{{ member.name or member.username or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}</span>
                    {% if member.is_captain %}
                      <span class="badge text-bg-warning text-dark">–ö–∞–ø–∏—Ç–∞–Ω</span>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted mb-0">–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</p>
            {% endif %}
          </section>

          <section class="mb-4">
            <h2 class="h6 text-uppercase text-muted mb-2">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞</h2>
            {% if user_is_captain %}
              <p class="fw-semibold mb-3">üéØ –í—ã–±–æ—Ä –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã</p>
              <form action="/team/select-quiz" method="post" class="mb-3">
                <input type="hidden" name="user_id" value="{{ captain_id }}" />
                <input type="hidden" name="team_id" value="{{ team.id }}" />
                <div class="mb-3">
                  <select
                    class="form-select"
                    id="team-quiz-select"
                    {% if available_quizzes %}
                      name="quiz_id"
                      required
                    {% else %}
                      disabled
                    {% endif %}
                  >
                    {% if available_quizzes %}
                      <option value="" disabled {% if not selected_quiz_id_str %}selected{% endif %}>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É</option>
                      {% for quiz in available_quizzes %}
                        {% set quiz_id_str = quiz.id|string %}
                        <option value="{{ quiz.id }}" {% if selected_quiz_id_str and quiz_id_str == selected_quiz_id_str %}selected{% endif %}>
                          {{ quiz.title }}
                        </option>
                      {% endfor %}
                    {% else %}
                      <option>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∏–∫—Ç–æ—Ä–∏–Ω</option>
                    {% endif %}
                  </select>
                </div>
                <button type="submit" class="btn btn-outline-primary" {% if not available_quizzes %}disabled{% endif %}>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä</button>
              </form>
              {% if selected_quiz %}
                <p class="mb-0">–í—ã–±—Ä–∞–Ω–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞: {{ selected_quiz.title }}</p>
              {% elif selected_quiz_id %}
                <p class="mb-0">–í—ã–±—Ä–∞–Ω–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞ ‚Ññ {{ selected_quiz_id }}.</p>
              {% else %}
                <p class="text-muted mb-0">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.</p>
              {% endif %}
            {% else %}
              {% if selected_quiz %}
                <p class="mb-0">–í—ã–±—Ä–∞–Ω–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞: {{ selected_qu–∏–∑.title }}</p>
              {% elif selected_qu–∏–∑_id %}
                <p class="mb-0">–í—ã–±—Ä–∞–Ω–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞ ‚Ññ {{ selected_qu–∏–∑_id }}.</p>
              {% else %}
                <p class="text-muted mb-0">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.</p>
              {% endif %}
            {% endif %}
            {% if quiz_error %}
              <div class="alert alert-warning mt-3 mb-0" role="alert">
                {{ quiz_error }}
              </div>
            {% endif %}
          </section>

          <section class="mb-4">
            <h2 class="h6 text-uppercase text-muted mb-3">–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ç—á–∞</h2>
            {% set match_identifier = team.match_id or team.id %}
            <div
              id="match-status-message"
              class="border rounded p-3 bg-body-tertiary small"
              data-team-id="{{ team.id }}"
              {% if current_user and current_user.id %}data-user-id="{{ current_user.id }}"{% elif captain_id %}data-user-id="{{ captain_id }}"{% endif %}
              {% if match_identifier %}data-match-id="{{ match_identifier }}"{% endif %}
              {% if match_info %}data-initial-status="{{ match_info | tojson | escape }}"{% endif %}
              {% if team_status_value is not none %}data-team-status="{{ team_status_value }}"{% endif %}
              {% if team_completed_value is not none %}data-team-completed="{{ 'true' if team_completed_value else 'false' }}"{% endif %}
              {% if match_status_value is not none %}data-match-status="{{ match_status_value }}"{% endif %}
              {% if match_team_status_value is not none %}data-match-team-status="{{ match_team_status_value }}"{% endif %}
              {% if match_team_completed_value is not none %}data-match-team-completed="{{ 'true' if match_team_completed_value else 'false' }}"{% endif %}
            >
              –û–∂–∏–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –º–∞—Ç—á–µ‚Ä¶
            </div>
          </section>

          <footer class="d-flex flex-column flex-md-row gap-2">
            {% if user_is_captain and (not match_info or match_status_value is none or match_status_value in ('waiting', 'ready')) %}
              <form id="start-game-form" action="/team/start" method="post" class="d-flex">
                <input type="hidden" name="user_id" value="{{ captain_id }}" />
                <input type="hidden" name="team_id" value="{{ team.id }}" />
                <button type="submit" class="btn btn-danger">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
              </form>
            {% endif %}

            {% if match_finished %}
              {% if match_info.results_url %}
                <a href="{{ match_info.results_url }}" class="btn btn-outline-primary">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</a>
              {% endif %}
              {% if user_is_captain and match_info.new_game_url %}
                <a href="{{ match_info.new_game_url }}" class="btn btn-primary">–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É</a>
              {% endif %}
            {% endif %}
          </footer>
        </div>
      </div>

      {% if last_response %}
        <div class="alert alert-info mt-4" role="alert">
          <h2 class="h6 mb-2">–ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç API</h2>
          <pre class="mb-0">{{ last_response | tojson(indent=2) }}</pre>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      const POLL_INTERVAL_MS = 4000;
      let matchPollTimer = null;

      const summaryContainer = document.getElementById("match-summary-alert");
      const statusMessage = document.getElementById("match-status-message");
      const statusDataset = statusMessage && statusMessage.dataset ? statusMessage.dataset : null;

      const normalizeId = (value) => {
        if (typeof value !== "string") return null;
        const trimmed = value.trim();
        if (!trimmed) return null;
        const lower = trimmed.toLowerCase();
        if (["none", "null", "undefined"].includes(lower)) return null;
        return trimmed;
      };

      const datasetMatchId = normalizeId(statusDataset ? statusDataset.matchId : null);
      const datasetUserId = normalizeId(statusDataset ? statusDataset.userId : null);
      const datasetTeamId = normalizeId(statusDataset ? statusDataset.teamId : null);

      const parseBoolean = (value) => {
        if (value === undefined || value === null) return false;
        if (typeof value === "boolean") return value;
        if (typeof value === "number") return value !== 0;
        if (typeof value === "string") {
          const normalized = value.trim().toLowerCase();
          if (!normalized) return false;
          return ["true", "1", "yes", "on"].includes(normalized);
        }
        return false;
      };

      const normalizeStatus = (value) => {
        const normalized = normalizeId(value);
        return normalized ? normalized.toLowerCase() : null;
      };

      const datasetMatchStatus = normalizeStatus(statusDataset ? statusDataset.matchStatus : null);
      const datasetTeamStatus = normalizeStatus(statusDataset ? statusDataset.teamStatus : null);
      const datasetTeamCompleted = parseBoolean(statusDataset ? statusDataset.teamCompleted : null);
      const datasetMatchTeamStatus = normalizeStatus(statusDataset ? statusDataset.matchTeamStatus : null);
      const datasetMatchTeamCompleted = parseBoolean(statusDataset ? statusDataset.matchTeamCompleted : null);

      let currentMatchId = datasetMatchId;
      const currentUserId = datasetUserId;
      const currentTeamId = datasetTeamId;

      let matchFinished = datasetMatchStatus === "finished";
      let teamFinished =
        datasetTeamStatus === "finished" ||
        datasetMatchTeamStatus === "finished" ||
        datasetTeamCompleted ||
        datasetMatchTeamCompleted;

      const markTeamFinished = () => { teamFinished = true; };
      const markMatchFinished = () => { matchFinished = true; };

      const handleJsonResponse = async (response) => {
        let data = null;
        try {
          data = await response.json();
        } catch (_) {}
        if (!response.ok || data === null) {
          const detail = data && data.detail;
          const message =
            (typeof detail === "string" && detail) ||
            (detail && detail.error) ||
            (detail && detail.message) ||
            response.statusText ||
            "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
          throw new Error(message);
        }
        return data;
      };

      const toJsonPayload = (form) => {
        const formData = new FormData(form);
        const payload = {};
        formData.forEach((value, key) => { payload[key] = value; });
        return payload;
      };

      const escapeHtml = (value) => {
        if (value === undefined || value === null) return "";
        return String(value).replace(/[&<>"']/g, (char) => {
          switch (char) {
            case "&": return "&amp;";
            case "<": return "&lt;";
            case ">": return "&gt;";
            case '"': return "&quot;";
            case "'": return "&#39;";
            default: return char;
          }
        });
      };

      const renderSummary = (html) => {
        if (!summaryContainer) return;
        summaryContainer.innerHTML = html || "";
      };

      const renderTeamCompletedSummary = () => {
        renderSummary(
          '<div class="alert alert-success"><p class="mb-0">üèÅ –í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞ –∏–≥—Ä—É. –û–∂–∏–¥–∞–µ–º –≤—Ç–æ—Ä—É—é –∫–æ–º–∞–Ω–¥—É‚Ä¶</p></div>'
        );
      };

      const extractWinnerData = (data) => {
        const result = data && typeof data === "object" ? data.result || data.result_summary || {} : {};
        const nameRaw =
          result.winner_team_name ??
          result.winnerTeamName ??
          result.winner_name ??
          result.winnerName ??
          null;
        const scoreRaw =
          result.winner_team_score ??
          result.winnerTeamScore ??
          result.score ??
          null;

        const winnerName = typeof nameRaw === "string" && nameRaw.trim() ? nameRaw.trim() : null;

        let winnerScore = null;
        if (scoreRaw !== undefined && scoreRaw !== null) {
          if (typeof scoreRaw === "number" && Number.isFinite(scoreRaw)) {
            winnerScore = String(scoreRaw);
          } else if (typeof scoreRaw === "string") {
            const trimmed = scoreRaw.trim();
            if (trimmed) {
              const numeric = Number(trimmed);
              winnerScore = Number.isFinite(numeric) ? String(numeric) : trimmed;
            }
          }
        }

        return { winnerName, winnerScore };
      };

      const buildFinishedText = (data) => {
        const { winnerName, winnerScore } = extractWinnerData(data);
        if (winnerName && winnerScore !== null) {
          return `‚úÖ ${escapeHtml("–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")} ${escapeHtml("–†–µ–∑—É–ª—å—Ç–∞—Ç:")} ${escapeHtml(
            "–∫–æ–º–∞–Ω–¥–∞"
          )} ${escapeHtml(winnerName)} ${escapeHtml("–ø–æ–±–µ–¥–∏–ª–∞ —Å–æ —Å—á—ë—Ç–æ–º")} ${escapeHtml(winnerScore)}.`;
        }
        if (winnerName) {
          return `‚úÖ ${escapeHtml("–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")} ${escapeHtml("–†–µ–∑—É–ª—å—Ç–∞—Ç:")} ${escapeHtml(
            "–∫–æ–º–∞–Ω–¥–∞"
          )} ${escapeHtml(winnerName)} ${escapeHtml("–ø–æ–±–µ–¥–∏–ª–∞.")}`;
        }
        if (winnerScore !== null) {
          return `‚úÖ ${escapeHtml("–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")} ${escapeHtml("–ü–æ–±–µ–¥–Ω—ã–π —Å—á—ë—Ç:")} ${escapeHtml(
            winnerScore
          )}.`;
        }
        return `‚úÖ ${escapeHtml("–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")}`;
      };

      const renderMatchFinishedSummary = (data) => {
        const resultsUrl = typeof data?.results_url === "string" && data.results_url ? data.results_url : null;
        const finishedText = buildFinishedText(data);
        const linkHtml = resultsUrl
          ? ` <a class="alert-link" href="${escapeHtml(resultsUrl)}">${escapeHtml("–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã")}</a>.`
          : "";
        renderSummary(`<div class="alert alert-success"><p class="mb-0">${finishedText}${linkHtml}</p></div>`);
      };

      const formatTeamName = (team) => {
        if (!team) return escapeHtml("–ö–æ–º–∞–Ω–¥–∞");
        const fallback = team.id ? `–ö–æ–º–∞–Ω–¥–∞ ${team.id}` : "–ö–æ–º–∞–Ω–¥–∞";
        return escapeHtml(team.name || fallback);
      };

      const renderError = (message) => {
        if (!statusMessage) return;
        statusMessage.innerHTML = `<p class="mb-0 text-danger">${escapeHtml(message)}</p>`;
      };

      const stopPolling = () => {
        if (matchPollTimer) {
          clearInterval(matchPollTimer);
          matchPollTimer = null;
        }
      };

      const startPolling = () => {
        if (matchPollTimer || !currentMatchId) return;
        matchPollTimer = setInterval(() => {
          fetchMatchStatus(currentMatchId).catch((error) => {
            console.error("Failed to poll match status", error);
          });
        }, POLL_INTERVAL_MS);
      };

      const buildGameRedirect = (redirect) => {
        if (typeof redirect !== "string" || !redirect) return redirect;
        try {
          const url = new URL(redirect, window.location.origin);
          if (currentTeamId) url.searchParams.set("team_id", currentTeamId);
          if (currentUserId) url.searchParams.set("user_id", currentUserId);
          return url.toString();
        } catch (_) {
          return redirect;
        }
      };

      const buildStatusUrl = (matchId) => {
        const url = new URL(`/match/status/${encodeURIComponent(matchId)}`, window.location.origin);
        if (currentTeamId) url.searchParams.set("team_id", currentTeamId);
        if (currentUserId) url.searchParams.set("user_id", currentUserId);
        return url.toString();
      };

      const renderTeamCompletedStatus = () => {
        if (!statusMessage) return;
        statusMessage.innerHTML =
          '<p class="mb-0 text-success">üèÅ –í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞ –∏–≥—Ä—É. –û–∂–∏–¥–∞–µ–º –≤—Ç–æ—Ä—É—é –∫–æ–º–∞–Ω–¥—É‚Ä¶</p>';
        renderTeamCompletedSummary();
      };

      const shouldRedirectToGame = (data) => {
        if (matchFinished || teamFinished) return false;
        return typeof data?.redirect === "string" && data.redirect;
      };

      const renderWaitingStatus = (data) => {
        if (!statusMessage) return;

        const teams = Array.isArray(data?.teams) ? data.teams : [];
        if (!teams.length) {
          statusMessage.innerHTML = `<p class="mb-0">${escapeHtml("–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥.")}</p>`;
          return;
        }

        const waitingTeams = teams.filter((team) => !team.ready);
        const otherWaitingNames = waitingTeams
          .filter((team) => !currentTeamId || team.id !== currentTeamId)
          .map((team) => formatTeamName(team));

        const isCurrentTeamKnown = teams.some((team) => team.id === currentTeamId);
        const isCurrentTeamReady = teams.some((team) => team.id === currentTeamId && team.ready);

        let introHtml;
        if (isCurrentTeamReady) {
          if (otherWaitingNames.length) {
            introHtml = `${escapeHtml("–í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞. –ñ–¥—ë–º ")}${otherWaitingNames.join(", ")}.`;
          } else if (waitingTeams.length) {
            introHtml = escapeHtml("–í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞. –ñ–¥—ë–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.");
          } else {
            introHtml = escapeHtml("–í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞. –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫ –º–∞—Ç—á–∞.");
          }
        } else if (isCurrentTeamKnown) {
          introHtml = escapeHtml("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –º–∞—Ç—á.");
        } else {
          introHtml = escapeHtml("–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥.");
        }

        const itemsHtml = teams
          .map((team) => {
            const name = formatTeamName(team);
            const statusClass = team.ready ? "text-success" : "text-warning";
            const statusText = team.ready ? "–≥–æ—Ç–æ–≤–∞ ‚úÖ" : "–∂–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è‚Ä¶";
            const suffix = currentTeamId && team.id === currentTeamId ? " <span class=\"text-muted\">(–≤–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞)</span>" : "";
            return `<li class="mb-1"><span class="fw-semibold">${name}</span>${suffix} ‚Äî <span class="${statusClass}">${escapeHtml(statusText)}</span></li>`;
          })
          .join("");

        statusMessage.innerHTML = `
          <p class="mb-2">${introHtml}</p>
          <ul class="list-unstyled mb-0">${itemsHtml}</ul>
        `;
      };

      const renderReadyStatus = (data) => {
        if (!statusMessage) return;

        const shouldRedirect = shouldRedirectToGame(data);
        const summaryText = shouldRedirect
          ? "–í—Å–µ –∫–æ–º–∞–Ω–¥—ã –≥–æ—Ç–æ–≤—ã. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∏–≥—Ä–µ‚Ä¶"
          : "–í—Å–µ –∫–æ–º–∞–Ω–¥—ã –≥–æ—Ç–æ–≤—ã. –ú–∞—Ç—á –≥–æ—Ç–æ–≤ –∫ —Å—Ç–∞—Ä—Ç—É.";
        statusMessage.innerHTML = `<p class="mb-0 text-success">${escapeHtml(summaryText)}</p>`;

        if (shouldRedirect) {
          stopPolling();
          setTimeout(() => {
            window.location.href = buildGameRedirect(data.redirect);
          }, 500);
        } else {
          startPolling();
        }
      };

      const renderStartedStatus = (data) => {
        if (!statusMessage) return;

        const teams = Array.isArray(data?.teams) ? data.teams : [];
        const shouldRedirect = shouldRedirectToGame(data);
        const summaryText = shouldRedirect
          ? "–í—Å–µ –∫–æ–º–∞–Ω–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –∏–≥—Ä—É‚Ä¶"
          : "–í—Å–µ –∫–æ–º–∞–Ω–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å. –ò–≥—Ä–∞ –∏–¥—ë—Ç.";
        const summary = escapeHtml(summaryText);

        if (!teams.length) {
          statusMessage.innerHTML = `<p class="mb-0 text-success">${summary}</p>`;
        } else {
          const itemsHtml = teams
            .map((team) => {
              const name = formatTeamName(team);
              const suffix = currentTeamId && team.id === currentTeamId ? " <span class=\"text-muted\">(–≤–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞)</span>" : "";
              return `<li class="mb-1"><span class="fw-semibold">${name}</span>${suffix}</li>`;
            })
            .join("");

          statusMessage.innerHTML = `
            <p class="mb-2 text-success">${summary}</p>
            <ul class="list-unstyled mb-0">${itemsHtml}</ul>
          `;
        }

        if (shouldRedirect) {
          stopPolling();
          setTimeout(() => {
            window.location.href = buildGameRedirect(data.redirect);
          }, 400);
        } else {
          startPolling();
        }
      };

      const renderFinishedStatus = (data) => {
        if (!statusMessage) return;
        const resultsUrl = typeof data?.results_url === "string" && data.results_url ? data.results_url : null;
        const finishedText = buildFinishedText(data);
        const linkHtml = resultsUrl
          ? ` <a class="link-success fw-semibold" href="${escapeHtml(resultsUrl)}">${escapeHtml("–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã")}</a>.`
          : "";
        statusMessage.innerHTML = `<p class="mb-0 text-success">${finishedText}${linkHtml}</p>`;
        renderMatchFinishedSummary(data);
        stopPolling();
      };

      const updateMatchStatus = (data) => {
        if (!statusMessage) return;

        if (!data || typeof data !== "object") {
          renderError("–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.");
          return;
        }

        const status = normalizeStatus(data.status);
        const nextMatchId = normalizeId(data.match_id);
        if (nextMatchId && currentMatchId !== nextMatchId) {
          currentMatchId = nextMatchId;
        }

        if (status === "finished") markMatchFinished();

        // 1) –ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∫–æ–Ω–µ—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        if (status === "finished" || matchFinished) {
          renderFinishedStatus(data);
          return;
        }

        // 2) –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∞–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã
        const dataTeamStatus = normalizeStatus(data.team_status || data.teamStatus);
        const dataTeamCompleted = parseBoolean(
          data.team_completed !== undefined ? data.team_completed : data.teamCompleted
        );
        if (dataTeamStatus === "finished" || dataTeamCompleted) {
          markTeamFinished();
        } else if (!teamFinished && Array.isArray(data.teams)) {
          const ownTeam = data.teams.find((team) => {
            if (!team || typeof team !== "object") return false;
            if (team.is_yours) return true;
            const teamId = normalizeId(team.id);
            return Boolean(teamId && currentTeamId && teamId === currentTeamId);
          });
          if (ownTeam) {
            const ownStatus = normalizeStatus(ownTeam.status || ownTeam.team_status);
            const ownCompleted = parseBoolean(
              ownTeam.team_completed !== undefined
                ? ownTeam.team_completed
                : ownTeam.completed ?? ownTeam.finished
            );
            if (ownStatus === "finished" || ownCompleted) {
              markTeamFinished();
            }
          }
        }

        // 3) –ü–æ–¥—Å–≤–µ—Ç–∫–∞: –µ—Å–ª–∏ –Ω–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ —Ñ–∏–Ω–∏—à–∏—Ä–æ–≤–∞–ª–∞, –Ω–æ –º–∞—Ç—á –µ—â—ë –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ¬´–û–∂–∏–¥–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –∫–æ–º–∞–Ω–¥¬ª
        // 4) –†–µ–Ω–¥–µ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if (teamFinished && !matchFinished) {
          renderTeamCompletedStatus();
          startPolling();
          return;
        }

        if (status === "waiting") {
          renderWaitingStatus(data);
          startPolling();
        } else if (status === "ready") {
          renderReadyStatus(data);
        } else if (status === "started") {
          renderStartedStatus(data);
        } else {
          statusMessage.textContent = JSON.stringify(data, null, 2);
          startPolling();
        }
      };

      const fetchMatchStatus = async (matchId) => {
        const normalizedId = normalizeId(matchId);
        if (!normalizedId) return;

        const url = buildStatusUrl(normalizedId);
        const pollResponse = await fetch(url, { credentials: "same-origin" });
        const pollData = await handleJsonResponse(pollResponse);
        updateMatchStatus(pollData);
      };

      // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π JSON, –∏–Ω–∞—á–µ ‚Äî fetch.
      if (statusDataset && statusDataset.initialStatus) {
        try {
          const initialStatus = JSON.parse(statusDataset.initialStatus);
          updateMatchStatus(initialStatus);
        } catch (error) {
          console.warn("Failed to parse initial match status", error);
          if (currentMatchId) {
            fetchMatchStatus(currentMatchId).catch((err) => {
              console.error("Failed to fetch match status after parse error", err);
              // –ú—è–≥–∫–∏–π bootstrap –∏–∑ data-* —á—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ—Ç—å –Ω–∞ –∑–∞–≥–ª—É—à–∫–µ
              if (teamFinished && !matchFinished) {
                renderTeamCompletedStatus();
                startPolling();
              }
            });
          }
        }
        delete statusMessage.dataset.initialStatus;
      } else if (currentMatchId) {
        fetchMatchStatus(currentMatchId).catch((error) => {
          console.error("Failed to fetch initial match status", error);
          // –ú—è–≥–∫–∏–π bootstrap –∏–∑ data-* —á—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ—Ç—å –Ω–∞ –∑–∞–≥–ª—É—à–∫–µ
          if (teamFinished && !matchFinished) {
            renderTeamCompletedStatus();
            startPolling();
          }
        });
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã ¬´–ù–∞—á–∞—Ç—å –∏–≥—Ä—É¬ª
      const startGameForm = document.getElementById("start-game-form");
      if (startGameForm && statusMessage) {
        startGameForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          stopPolling();
          statusMessage.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞‚Ä¶";

          const payload = toJsonPayload(startGameForm);

          try {
            const fetchResponse = await fetch(startGameForm.action, {
              method: startGameForm.method.toUpperCase(),
              headers: { "Content-Type": "application/json" },
              credentials: "same-origin",
              body: JSON.stringify(payload),
            });

            const data = await handleJsonResponse(fetchResponse);
            updateMatchStatus(data);
          } catch (error) {
            renderError(error.message || String(error));
          }
        });
      }
    })();
  </script>
{% endblock %}
