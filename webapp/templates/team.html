{% extends "base.html" %}

{% block title %}–ö–æ–º–∞–Ω–¥–∞ ¬∑ –ö–æ–º–∞–Ω–¥–Ω–∞—è –í–∏–∫—Ç–æ—Ä–∏–Ω–∞{% endblock %}

{% block content %}
  {% set team = team or {} %}
  <div class="row justify-content-center">
    <div class="col-lg-9 col-xl-8">
      {% if match_status and match_status.status == 'finished' %}
        <div class="alert alert-success">
          üèÅ –í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞ –∏–≥—Ä—É!
          <p>–†–µ–∑—É–ª—å—Ç–∞—Ç: {{ match_status.score or '?' }} –æ—á–∫–æ–≤.</p>
        </div>
      {% endif %}

      <div class="card shadow-sm">
        <div class="card-body">
          <header class="mb-4">
            <div class="d-flex flex-wrap align-items-baseline justify-content-between gap-3">
              <div>
                <h1 class="h4 mb-1">{{ team.name or (team.id and ('–ö–æ–º–∞–Ω–¥–∞ ' ~ team.id)) or '–ö–æ–º–∞–Ω–¥–∞' }}</h1>
                {% if team.code %}
                  <span class="badge text-bg-secondary">–ö–æ–¥: {{ team.code }}</span>
                {% endif %}
              </div>
              {% if user_is_captain %}
                <span class="badge text-bg-warning text-dark">–í—ã ‚Äî –∫–∞–ø–∏—Ç–∞–Ω</span>
              {% endif %}
            </div>
          </header>

          <section class="mb-4">
            <h2 class="h6 text-uppercase text-muted mb-2">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
            {% if team.members %}
              <ul class="list-unstyled mb-0">
                {% for member in team.members %}
                  <li class="d-flex align-items-center gap-2 py-1">
                    <span class="fw-semibold">{{ member.name or member.username or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}</span>
                    {% if member.is_captain %}
                      <span class="badge text-bg-warning text-dark">–ö–∞–ø–∏—Ç–∞–Ω</span>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted mb-0">–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</p>
            {% endif %}
          </section>

          <section class="mb-4">
            <h2 class="h6 text-uppercase text-muted mb-2">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞</h2>
            <div>
              {% if selected_quiz %}
                <p class="mb-1">–í—ã–±—Ä–∞–Ω–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞ <span class="fw-semibold">¬´{{ selected_quiz.title }}¬ª</span>.</p>
                <p class="text-muted small mb-0">ID –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã: {{ selected_quiz.id }}</p>
              {% elif selected_quiz_id %}
                <p class="mb-0">–í—ã–±—Ä–∞–Ω–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞ ‚Ññ {{ selected_quiz_id }}.</p>
              {% else %}
                <p class="text-muted mb-0">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.</p>
              {% endif %}
              {% if quiz_error %}
                <div class="alert alert-warning mt-3 mb-0" role="alert">
                  {{ quiz_error }}
                </div>
              {% endif %}
            </div>
          </section>

          <section class="mb-4">
            <h2 class="h6 text-uppercase text-muted mb-3">–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ç—á–∞</h2>
            <div class="list-group list-group-flush mb-3" id="match-status-steps">
              <div class="list-group-item px-0 d-flex align-items-center gap-3 text-muted" data-status-step="waiting">
                <span class="fs-4 status-icon">‚è≥</span>
                <span>–û–∂–∏–¥–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –∫–æ–º–∞–Ω–¥</span>
              </div>
              <div class="list-group-item px-0 d-flex align-items-center gap-3 text-muted" data-status-step="ready">
                <span class="fs-4 status-icon">‚úÖ</span>
                <span>–ì–æ—Ç–æ–≤—ã –∫ —Å—Ç–∞—Ä—Ç—É</span>
              </div>
              <div class="list-group-item px-0 d-flex align-items-center gap-3 text-muted" data-status-step="started">
                <span class="fs-4 status-icon">üéÆ</span>
                <span>–ò–≥—Ä–∞ –∏–¥—ë—Ç</span>
              </div>
              <div class="list-group-item px-0 d-flex align-items-center gap-3 text-muted" data-status-step="finished">
                <span class="fs-4 status-icon">üèÅ</span>
                <span>–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</span>
              </div>
            </div>
            {% set match_identifier = team.match_id or team.id %}
            <div
              id="match-status-message"
              class="border rounded p-3 bg-body-tertiary small"
              data-team-id="{{ team.id }}"
              {% if current_user and current_user.id %}data-user-id="{{ current_user.id }}"{% elif captain_id %}data-user-id="{{ captain_id }}"{% endif %}
              {% if match_identifier %}data-match-id="{{ match_identifier }}"{% endif %}
              {% if match_status %}data-initial-status="{{ match_status | tojson | escape }}"{% endif %}
            >
              –û–∂–∏–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –º–∞—Ç—á–µ‚Ä¶
            </div>
          </section>

          <footer class="d-flex flex-column flex-md-row gap-2">
            {% if user_is_captain and (not match_status or match_status.status in ('waiting', 'ready')) %}
              <form id="start-game-form" action="/team/start" method="post" class="d-flex">
                <input type="hidden" name="user_id" value="{{ captain_id }}" />
                <input type="hidden" name="team_id" value="{{ team.id }}" />
                <button type="submit" class="btn btn-danger">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
              </form>
            {% endif %}

            {% if match_status and match_status.status == 'finished' %}
              {% if match_status.results_url %}
                <a href="{{ match_status.results_url }}" class="btn btn-outline-primary">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</a>
              {% endif %}
              {% if user_is_captain and match_status.new_game_url %}
                <a href="{{ match_status.new_game_url }}" class="btn btn-primary">–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É</a>
              {% endif %}
            {% endif %}
          </footer>
        </div>
      </div>

      {% if last_response %}
        <div class="alert alert-info mt-4" role="alert">
          <h2 class="h6 mb-2">–ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç API</h2>
          <pre class="mb-0">{{ last_response | tojson(indent=2) }}</pre>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      const POLL_INTERVAL_MS = 4000;
      let matchPollTimer = null;

      const statusMessage = document.getElementById("match-status-message");
      const statusDataset = statusMessage && statusMessage.dataset ? statusMessage.dataset : null;
      const statusSteps = document.querySelectorAll("[data-status-step]");

      const normalizeId = (value) => {
        if (typeof value !== "string") {
          return null;
        }

        const trimmed = value.trim();
        if (!trimmed) {
          return null;
        }

        const lower = trimmed.toLowerCase();
        if (lower === "none" || lower === "null" || lower === "undefined") {
          return null;
        }

        return trimmed;
      };

      const datasetMatchId = normalizeId(statusDataset ? statusDataset.matchId : null);
      const datasetUserId = normalizeId(statusDataset ? statusDataset.userId : null);
      const datasetTeamId = normalizeId(statusDataset ? statusDataset.teamId : null);

      let currentMatchId = datasetMatchId;
      const currentUserId = datasetUserId;
      const currentTeamId = datasetTeamId;

      const handleJsonResponse = async (response) => {
        let data = null;
        try {
          data = await response.json();
        } catch (_) {}

        if (!response.ok || data === null) {
          const detail = data && data.detail;
          const message =
            (typeof detail === "string" && detail) ||
            (detail && detail.error) ||
            (detail && detail.message) ||
            response.statusText ||
            "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
          throw new Error(message);
        }

        return data;
      };

      const toJsonPayload = (form) => {
        const formData = new FormData(form);
        const payload = {};
        formData.forEach((value, key) => {
          payload[key] = value;
        });
        return payload;
      };

      const escapeHtml = (value) => {
        if (value === undefined || value === null) {
          return "";
        }
        return String(value).replace(/[&<>"']/g, (char) => {
          switch (char) {
            case "&":
              return "&amp;";
            case "<":
              return "&lt;";
            case ">":
              return "&gt;";
            case '"':
              return "&quot;";
            case "'":
              return "&#39;";
            default:
              return char;
          }
        });
      };

      const applyStatusHighlight = (status) => {
        statusSteps.forEach((step) => {
          const key = step.dataset.statusStep;
          const isActive = key === status;
          step.classList.toggle("text-muted", !isActive);
          step.classList.toggle("text-success", isActive);
          step.classList.toggle("fw-semibold", isActive);
          const icon = step.querySelector(".status-icon");
          if (icon) {
            icon.classList.toggle("opacity-50", !isActive);
            icon.classList.toggle("text-success", isActive);
          }
        });
      };

      const formatTeamName = (team) => {
        if (!team) {
          return escapeHtml("–ö–æ–º–∞–Ω–¥–∞");
        }
        const fallback = team.id ? `–ö–æ–º–∞–Ω–¥–∞ ${team.id}` : "–ö–æ–º–∞–Ω–¥–∞";
        return escapeHtml(team.name || fallback);
      };

      const renderError = (message) => {
        if (!statusMessage) {
          return;
        }
        statusMessage.innerHTML = `<p class="mb-0 text-danger">${escapeHtml(message)}</p>`;
      };

      const stopPolling = () => {
        if (matchPollTimer) {
          clearInterval(matchPollTimer);
          matchPollTimer = null;
        }
      };

      const startPolling = () => {
        if (matchPollTimer || !currentMatchId) {
          return;
        }
        matchPollTimer = setInterval(() => {
          fetchMatchStatus(currentMatchId).catch((error) => {
            console.error("Failed to poll match status", error);
          });
        }, POLL_INTERVAL_MS);
      };

      const buildGameRedirect = (redirect) => {
        if (typeof redirect !== "string" || !redirect) {
          return redirect;
        }

        try {
          const url = new URL(redirect, window.location.origin);
          if (currentTeamId) {
            url.searchParams.set("team_id", currentTeamId);
          }
          if (currentUserId) {
            url.searchParams.set("user_id", currentUserId);
          }
          return url.toString();
        } catch (_) {
          return redirect;
        }
      };

      const renderWaitingStatus = (data) => {
        if (!statusMessage) {
          return;
        }

        const teams = Array.isArray(data?.teams) ? data.teams : [];
        if (!teams.length) {
          statusMessage.innerHTML = `<p class="mb-0">${escapeHtml(
            "–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥."
          )}</p>`;
          return;
        }

        const waitingTeams = teams.filter((team) => !team.ready);
        const otherWaitingNames = waitingTeams
          .filter((team) => !currentTeamId || team.id !== currentTeamId)
          .map((team) => formatTeamName(team));

        const isCurrentTeamKnown = teams.some((team) => team.id === currentTeamId);
        const isCurrentTeamReady = teams.some((team) => team.id === currentTeamId && team.ready);

        let introHtml;
        if (isCurrentTeamReady) {
          if (otherWaitingNames.length) {
            introHtml = `${escapeHtml("–í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞. –ñ–¥—ë–º ")}${otherWaitingNames.join(", ")}.`;
          } else if (waitingTeams.length) {
            introHtml = escapeHtml("–í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞. –ñ–¥—ë–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.");
          } else {
            introHtml = escapeHtml("–í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞. –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫ –º–∞—Ç—á–∞.");
          }
        } else if (isCurrentTeamKnown) {
          introHtml = escapeHtml("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –º–∞—Ç—á.");
        } else {
          introHtml = escapeHtml("–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥.");
        }

        const itemsHtml = teams
          .map((team) => {
            const name = formatTeamName(team);
            const statusClass = team.ready ? "text-success" : "text-warning";
            const statusText = team.ready ? "–≥–æ—Ç–æ–≤–∞ ‚úÖ" : "–∂–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è‚Ä¶";
            const suffix = currentTeamId && team.id === currentTeamId ? " <span class=\"text-muted\">(–≤–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞)</span>" : "";
            return `<li class="mb-1"><span class="fw-semibold">${name}</span>${suffix} ‚Äî <span class="${statusClass}">${escapeHtml(
              statusText
            )}</span></li>`;
          })
          .join("");

        statusMessage.innerHTML = `
          <p class="mb-2">${introHtml}</p>
          <ul class="list-unstyled mb-0">${itemsHtml}</ul>
        `;
      };

      const renderReadyStatus = (data) => {
        if (!statusMessage) {
          return;
        }

        const summary = escapeHtml("–í—Å–µ –∫–æ–º–∞–Ω–¥—ã –≥–æ—Ç–æ–≤—ã. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∏–≥—Ä–µ‚Ä¶");
        statusMessage.innerHTML = `<p class="mb-0 text-success">${summary}</p>`;
        stopPolling();

        if (typeof data.redirect === "string" && data.redirect) {
          setTimeout(() => {
            window.location.href = buildGameRedirect(data.redirect);
          }, 500);
        }
      };

      const renderStartedStatus = (data) => {
        if (!statusMessage) {
          return;
        }

        const teams = Array.isArray(data?.teams) ? data.teams : [];
        const summary = escapeHtml("–í—Å–µ –∫–æ–º–∞–Ω–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –∏–≥—Ä—É‚Ä¶");

        if (!teams.length) {
          statusMessage.innerHTML = `<p class="mb-0 text-success">${summary}</p>`;
        } else {
          const itemsHtml = teams
            .map((team) => {
              const name = formatTeamName(team);
              const suffix = currentTeamId && team.id === currentTeamId ? " <span class=\"text-muted\">(–≤–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞)</span>" : "";
              return `<li class="mb-1"><span class="fw-semibold">${name}</span>${suffix}</li>`;
            })
            .join("");

          statusMessage.innerHTML = `
            <p class="mb-2 text-success">${summary}</p>
            <ul class="list-unstyled mb-0">${itemsHtml}</ul>
          `;
        }

        stopPolling();

        if (typeof data.redirect === "string" && data.redirect) {
          setTimeout(() => {
            window.location.href = buildGameRedirect(data.redirect);
          }, 400);
        }
      };

      const renderFinishedStatus = (data) => {
        if (!statusMessage) {
          return;
        }
        const message = data && data.message ? data.message : "–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω. –ú–æ–∂–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.";
        statusMessage.innerHTML = `<p class="mb-0 text-success">${escapeHtml(message)}</p>`;
        stopPolling();
      };

      const updateMatchStatus = (data) => {
        if (!statusMessage) {
          return;
        }

        if (!data || typeof data !== "object") {
          renderError("–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.");
          return;
        }

        const status = data.status;
        applyStatusHighlight(status);

        if (status === "waiting") {
          renderWaitingStatus(data);
          const nextMatchId = normalizeId(data.match_id);
          if (nextMatchId) {
            if (currentMatchId !== nextMatchId) {
              currentMatchId = nextMatchId;
              stopPolling();
            }
            startPolling();
          }
        } else if (status === "ready") {
          renderReadyStatus(data);
        } else if (status === "started") {
          renderStartedStatus(data);
        } else if (status === "finished") {
          renderFinishedStatus(data);
        } else {
          statusMessage.textContent = JSON.stringify(data, null, 2);
        }
      };

      const fetchMatchStatus = async (matchId) => {
        const normalizedId = normalizeId(matchId);
        if (!normalizedId) {
          return;
        }

        const pollResponse = await fetch(`/match/status/${encodeURIComponent(normalizedId)}`);
        const pollData = await handleJsonResponse(pollResponse);
        updateMatchStatus(pollData);
      };

      if (statusDataset && statusDataset.initialStatus) {
        try {
          const initialStatus = JSON.parse(statusDataset.initialStatus);
          updateMatchStatus(initialStatus);
        } catch (error) {
          console.warn("Failed to parse initial match status", error);
        }
        delete statusMessage.dataset.initialStatus;
      } else if (currentMatchId) {
        fetchMatchStatus(currentMatchId).catch((error) => {
          console.error("Failed to fetch initial match status", error);
        });
      }

      const startGameForm = document.getElementById("start-game-form");
      if (startGameForm && statusMessage) {
        startGameForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          stopPolling();
          statusMessage.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞‚Ä¶";

          const payload = toJsonPayload(startGameForm);

          try {
            const fetchResponse = await fetch(startGameForm.action, {
              method: startGameForm.method.toUpperCase(),
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const data = await handleJsonResponse(fetchResponse);
            updateMatchStatus(data);
          } catch (error) {
            renderError(error.message || String(error));
          }
        });
      }
    })();
  </script>
{% endblock %}