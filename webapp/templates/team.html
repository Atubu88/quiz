{% extends "base.html" %}

{% block title %}Команда · Командная Викторина{% endblock %}

{% block content %}
  {% set team = team or {} %}
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h1 class="h3 mb-4">Информация о команде</h1>
          <dl class="row">
            <dt class="col-sm-4">Название</dt>
            <dd class="col-sm-8">{{ team.name or "—" }}</dd>

            <dt class="col-sm-4">Код приглашения</dt>
            <dd class="col-sm-8">
              {% if team.code %}
                <span class="badge text-bg-primary fs-6">{{ team.code }}</span>
              {% else %}
                —
              {% endif %}
            </dd>

            <dt class="col-sm-4">Участники</dt>
            <dd class="col-sm-8">
              {% if team.members %}
                <ul class="list-group list-group-flush">
                  {% for member in team.members %}
                    <li class="list-group-item px-0">
                      <span class="fw-semibold">{{ member.name or member.username or "Без имени" }}</span>
                      {% if member.is_captain %}
                        <span class="badge text-bg-warning ms-2">Капитан</span>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted mb-0">Пока нет участников.</p>
              {% endif %}
            </dd>
          </dl>
        </div>
      </div>

      {% if current_member or user_is_captain %}
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h2 class="h4 mb-3">Управление командой</h2>

            {% if current_member and not current_member.is_captain %}
              <form
                id="leave-team-form"
                action="/team/leave"
                method="post"
                class="d-flex flex-column flex-sm-row align-items-start gap-2 mb-3"
              >
                <input type="hidden" name="team_id" value="{{ team.id }}" />
                <input type="hidden" name="user_id" value="{{ current_user.id }}" />
                <button type="submit" class="btn btn-outline-secondary">Выйти из команды</button>
              </form>
            {% endif %}

            {% if user_is_captain %}
              <form
                id="delete-team-form"
                action="/team/delete"
                method="post"
                class="d-flex flex-column flex-sm-row align-items-start gap-2"
              >
                <input type="hidden" name="team_id" value="{{ team.id }}" />
                <input type="hidden" name="user_id" value="{{ current_user.id if current_user else captain_id }}" />
                <button type="submit" class="btn btn-outline-danger">Удалить команду</button>
              </form>
              <p class="text-muted small mt-3 mb-0">
                Удаление команды автоматически исключит всех участников и очистит результаты игры.
              </p>
            {% endif %}
          </div>
        </div>
      {% endif %}

      {% if user_is_captain %}
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h2 class="h4 mb-3">Управление игрой</h2>
            <form id="start-game-form" action="/team/start" method="post">
              <div class="mb-3">
                <label for="start-user" class="form-label">ID капитана</label>
                <input type="number" class="form-control" id="start-user" name="user_id" value="{{ captain_id }}" placeholder="Введите ID" required />
              </div>
              <input type="hidden" name="team_id" value="{{ team.id }}" />
              <button type="submit" class="btn btn-danger">Начать игру</button>
            </form>
            <div class="mt-3">
              <h3 class="h6 text-muted">Ответ сервера</h3>
              <div
                class="border rounded p-3 bg-body-secondary"
                id="start-game-response"
                aria-live="polite"
                {% if match_status %}data-initial-status="{{ match_status | tojson | escape }}"{% endif %}
              >
                Ожидание запроса…
              </div>
            </div>
          </div>
        </div>
      {% endif %}

      {% if last_response %}
        <div class="alert alert-info" role="alert">
          <h2 class="h6 mb-2">Последний ответ API</h2>
          <pre class="mb-0">{{ last_response | tojson(indent=2) }}</pre>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      const POLL_INTERVAL_MS = 4000;
      let matchPollTimer = null;
      let currentMatchId = null;

      const handleJsonResponse = async (response) => {
        let data = null;
        try {
          data = await response.json();
        } catch (_) {}

        if (!response.ok || data === null) {
          const detail = data && data.detail;
          const message =
            (typeof detail === "string" && detail) ||
            (detail && detail.error) ||
            (detail && detail.message) ||
            response.statusText ||
            "Неизвестная ошибка";
          throw new Error(message);
        }

        return data;
      };

      const toJsonPayload = (form) => {
        const formData = new FormData(form);
        const payload = {};
        formData.forEach((value, key) => {
          payload[key] = value;
        });
        return payload;
      };

      const escapeHtml = (value) => {
        if (value === undefined || value === null) {
          return "";
        }
        return String(value).replace(/[&<>"']/g, (char) => {
          switch (char) {
            case "&":
              return "&amp;";
            case "<":
              return "&lt;";
            case ">":
              return "&gt;";
            case '"':
              return "&quot;";
            case "'":
              return "&#39;";
            default:
              return char;
          }
        });
      };

      const startGameForm = document.getElementById("start-game-form");
      const responseContainer = document.getElementById("start-game-response");
      const teamIdInput = startGameForm
        ? startGameForm.querySelector('input[name="team_id"]')
        : null;
      const currentTeamId = teamIdInput ? teamIdInput.value : null;

      const stopPolling = () => {
        if (matchPollTimer) {
          clearInterval(matchPollTimer);
          matchPollTimer = null;
        }
      };

      const renderError = (message) => {
        if (!responseContainer) {
          return;
        }
        responseContainer.innerHTML = `<p class="mb-0 text-danger">${escapeHtml(message)}</p>`;
      };

      const formatTeamName = (team) => {
        if (!team) {
          return escapeHtml("Команда");
        }
        const fallback = team.id ? `Команда ${team.id}` : "Команда";
        return escapeHtml(team.name || fallback);
      };

      const renderWaitingStatus = (container, data) => {
        const teams = Array.isArray(data?.teams) ? data.teams : [];

        if (!teams.length) {
          container.innerHTML = `<p class="mb-0">${escapeHtml(
            "Ожидаем подтверждение готовности команд."
          )}</p>`;
          return;
        }

        const waitingTeams = teams.filter((team) => !team.ready);
        const otherWaitingNames = waitingTeams
          .filter((team) => !currentTeamId || team.id !== currentTeamId)
          .map((team) => formatTeamName(team));

        const isCurrentTeamKnown = teams.some((team) => team.id === currentTeamId);
        const isCurrentTeamReady = teams.some((team) => team.id === currentTeamId && team.ready);

        let introHtml;
        if (isCurrentTeamReady) {
          if (otherWaitingNames.length) {
            introHtml = `${escapeHtml("Ваша команда готова. Ждём ")}${otherWaitingNames.join(", ")}.`;
          } else if (waitingTeams.length) {
            introHtml = escapeHtml("Ваша команда готова. Ждём остальных участников.");
          } else {
            introHtml = escapeHtml("Ваша команда готова. Ожидаем запуск матча.");
          }
        } else if (isCurrentTeamKnown) {
          introHtml = escapeHtml("Подтвердите готовность команды, чтобы начать матч.");
        } else {
          introHtml = escapeHtml("Ожидаем подтверждение готовности команд.");
        }

        const itemsHtml = teams
          .map((team) => {
            const name = formatTeamName(team);
            const statusClass = team.ready ? "text-success" : "text-warning";
            const statusText = team.ready ? "готова ✅" : "ждём подтверждения…";
            const suffix = currentTeamId && team.id === currentTeamId ? " <span class=\"text-muted\">(ваша команда)</span>" : "";
            return `<li class="mb-1"><span class="fw-semibold">${name}</span>${suffix} — <span class="${statusClass}">${escapeHtml(statusText)}</span></li>`;
          })
          .join("");

        container.innerHTML = `
          <p class="mb-2">${introHtml}</p>
          <ul class="list-unstyled mb-0">${itemsHtml}</ul>
        `;
      };

      const renderStartedStatus = (container, data) => {
        const teams = Array.isArray(data?.teams) ? data.teams : [];
        const summary = escapeHtml("Все команды подтвердили готовность. Перенаправляем в игру…");

        if (!teams.length) {
          container.innerHTML = `<p class="mb-0 text-success">${summary}</p>`;
          return;
        }

        const itemsHtml = teams
          .map((team) => {
            const name = formatTeamName(team);
            const suffix = currentTeamId && team.id === currentTeamId ? " <span class=\"text-muted\">(ваша команда)</span>" : "";
            return `<li class="mb-1"><span class="fw-semibold">${name}</span>${suffix}</li>`;
          })
          .join("");

        container.innerHTML = `
          <p class="mb-2 text-success">${summary}</p>
          <ul class="list-unstyled mb-0">${itemsHtml}</ul>
        `;
      };

      const updateMatchStatus = (data) => {
        if (!responseContainer) {
          return;
        }

        if (!data || typeof data !== "object") {
          renderError("Неожиданный ответ сервера.");
          return;
        }

        const status = data.status;
        if (status === "waiting") {
          renderWaitingStatus(responseContainer, data);
          if (typeof data.match_id === "string" && data.match_id) {
            if (currentMatchId !== data.match_id) {
              currentMatchId = data.match_id;
              stopPolling();
            }
            if (!matchPollTimer) {
              matchPollTimer = setInterval(async () => {
                try {
                  const pollResponse = await fetch(`/match/status/${encodeURIComponent(currentMatchId)}`);
                  const pollData = await handleJsonResponse(pollResponse);
                  updateMatchStatus(pollData);
                } catch (error) {
                  console.error("Failed to poll match status", error);
                }
              }, POLL_INTERVAL_MS);
            }
          }
        } else if (status === "started") {
          renderStartedStatus(responseContainer, data);
          stopPolling();

          if (typeof data.redirect === "string" && data.redirect) {
            setTimeout(() => {
              window.location.href = data.redirect;
            }, 400);
          }
        } else {
          responseContainer.textContent = JSON.stringify(data, null, 2);
        }
      };

      const initialStatusRaw = responseContainer && responseContainer.dataset
        ? responseContainer.dataset.initialStatus
        : null;
      if (initialStatusRaw) {
        try {
          const initialStatus = JSON.parse(initialStatusRaw);
          updateMatchStatus(initialStatus);
        } catch (error) {
          console.warn("Failed to parse initial match status", error);
        }
        delete responseContainer.dataset.initialStatus;
      }

      if (startGameForm && responseContainer) {
        startGameForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          stopPolling();
          responseContainer.textContent = "Отправка запроса…";

          const payload = toJsonPayload(startGameForm);

          try {
            const fetchResponse = await fetch(startGameForm.action, {
              method: startGameForm.method.toUpperCase(),
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const data = await handleJsonResponse(fetchResponse);
            updateMatchStatus(data);
          } catch (error) {
            renderError(error.message || String(error));
          }
        });
      }

      const leaveTeamForm = document.getElementById("leave-team-form");
      if (leaveTeamForm) {
        leaveTeamForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!confirm("Вы уверены, что хотите покинуть команду?")) {
            return;
          }

          const payload = toJsonPayload(leaveTeamForm);

          try {
            const response = await fetch(leaveTeamForm.action, {
              method: leaveTeamForm.method.toUpperCase(),
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const data = await handleJsonResponse(response);
            alert(data.message || "Вы покинули команду.");
            window.location.href = data.redirect || "/";
          } catch (error) {
            alert("Не удалось выйти из команды: " + (error.message || error));
          }
        });
      }

      const deleteTeamForm = document.getElementById("delete-team-form");
      if (deleteTeamForm) {
        deleteTeamForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!confirm("Удалить команду без возможности восстановления?")) {
            return;
          }

          const payload = toJsonPayload(deleteTeamForm);

          try {
            const response = await fetch(deleteTeamForm.action, {
              method: deleteTeamForm.method.toUpperCase(),
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const data = await handleJsonResponse(response);
            alert(data.message || "Команда удалена.");
            window.location.href = data.redirect || "/";
          } catch (error) {
            alert("Не удалось удалить команду: " + (error.message || error));
          }
        });
      }
    })();
  </script>
{% endblock %}