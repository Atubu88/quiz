{% extends "base.html" %}

{% block title %}Команда · Командная Викторина{% endblock %}

{% block content %}
  {% set team = team or {} %}
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h1 class="h3 mb-4">Информация о команде</h1>
          <dl class="row">
            <dt class="col-sm-4">Название</dt>
            <dd class="col-sm-8">{{ team.name or "—" }}</dd>

            <dt class="col-sm-4">Код приглашения</dt>
            <dd class="col-sm-8">
              {% if team.code %}
                <span class="badge text-bg-primary fs-6">{{ team.code }}</span>
              {% else %}
                —
              {% endif %}
            </dd>

            <dt class="col-sm-4">Участники</dt>
            <dd class="col-sm-8">
              {% if team.members %}
                <ul class="list-group list-group-flush">
                  {% for member in team.members %}
                    <li class="list-group-item px-0">
                      <span class="fw-semibold">{{ member.name or member.username or "Без имени" }}</span>
                      {% if member.is_captain %}
                        <span class="badge text-bg-warning ms-2">Капитан</span>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted mb-0">Пока нет участников.</p>
              {% endif %}
            </dd>
          </dl>
        </div>
      </div>

      {% if current_member or user_is_captain %}
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h2 class="h4 mb-3">Управление командой</h2>

            {% if current_member and not current_member.is_captain %}
              <form
                id="leave-team-form"
                action="/team/leave"
                method="post"
                class="d-flex flex-column flex-sm-row align-items-start gap-2 mb-3"
              >
                <input type="hidden" name="team_id" value="{{ team.id }}" />
                <input type="hidden" name="user_id" value="{{ current_user.id }}" />
                <button type="submit" class="btn btn-outline-secondary">Выйти из команды</button>
              </form>
            {% endif %}

            {% if user_is_captain %}
              <form
                id="delete-team-form"
                action="/team/delete"
                method="post"
                class="d-flex flex-column flex-sm-row align-items-start gap-2"
              >
                <input type="hidden" name="team_id" value="{{ team.id }}" />
                <input type="hidden" name="user_id" value="{{ current_user.id if current_user else captain_id }}" />
                <button type="submit" class="btn btn-outline-danger">Удалить команду</button>
              </form>
              <p class="text-muted small mt-3 mb-0">
                Удаление команды автоматически исключит всех участников и очистит результаты игры.
              </p>
            {% endif %}
          </div>
        </div>
      {% endif %}

      {% set match_identifier = team.match_id or team.id %}
      {% if user_is_captain or current_member %}
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h2 class="h4 mb-3">Управление игрой</h2>
            <div class="mb-4">
              <h3 class="h6 text-muted">Викторина</h3>
              {% if selected_quiz %}
                <p class="mb-2">
                  Выбрана викторина <span class="fw-semibold">«{{ selected_quiz.title }}»</span>.
                </p>
              {% elif selected_quiz_id %}
                <p class="mb-2">Выбрана викторина № {{ selected_quiz_id }}.</p>
              {% else %}
                <p class="mb-2 text-muted">Викторина пока не выбрана.</p>
              {% endif %}

              {% if quiz_error %}
                <div class="alert alert-warning mb-3" role="alert">
                  {{ quiz_error }}
                </div>
              {% endif %}

              {% if user_is_captain %}
                {% if available_quizzes %}
                  <div class="list-group mb-0">
                    {% for quiz in available_quizzes %}
                      {% set quiz_id_str = quiz.id ~ '' %}
                      {% set is_selected = selected_quiz_id_str and selected_quiz_id_str == quiz_id_str %}
                      <form
                        action="/team/select-quiz"
                        method="post"
                        class="list-group-item list-group-item-action"
                      >
                        <input type="hidden" name="team_id" value="{{ team.id }}" />
                        <input
                          type="hidden"
                          name="user_id"
                          value="{{ captain_id or (current_user.id if current_user else '') }}"
                        />
                        <input type="hidden" name="quiz_id" value="{{ quiz.id }}" />
                        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
                          <div class="flex-grow-1">
                            <span class="fw-semibold">{{ quiz.title or ('Викторина № ' ~ quiz.id) }}</span>
                            {% if is_selected %}
                              <span class="badge text-bg-success ms-2">Выбрано</span>
                            {% endif %}
                          </div>
                          <button
                            type="submit"
                            class="btn btn-outline-primary btn-sm ms-md-auto"
                            {% if is_selected %}disabled{% endif %}
                          >
                            {% if is_selected %}Выбрано{% else %}Выбрать{% endif %}
                          </button>
                        </div>
                      </form>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="text-muted mb-0">Нет доступных викторин для выбора.</p>
                {% endif %}
              {% endif %}
            </div>
            {% if user_is_captain %}
              <form id="start-game-form" action="/team/start" method="post">
                <input type="hidden" name="user_id" value="{{ captain_id }}" />
                <input type="hidden" name="team_id" value="{{ team.id }}" />
                <button type="submit" class="btn btn-danger">Начать игру</button>
              </form>
            {% else %}
              <p class="text-muted mb-3">Капитан запустит игру, когда все будут готовы.</p>
            {% endif %}
            <div class="mt-3">
              <h3 class="h6 text-muted">Статус игры</h3>
              <div
                class="border rounded p-3 bg-body-secondary"
                id="start-game-response"
                aria-live="polite"
                data-team-id="{{ team.id }}"
                {% if current_user and current_user.id %}data-user-id="{{ current_user.id }}"{% elif captain_id %}data-user-id="{{ captain_id }}"{% endif %}
                {% if match_identifier %}data-match-id="{{ match_identifier }}"{% endif %}
                {% if match_status %}data-initial-status="{{ match_status | tojson | escape }}"{% endif %}
              >
                Ожидание запроса…
              </div>
            </div>
          </div>
        </div>
      {% endif %}


      {% if last_response %}
        <div class="alert alert-info" role="alert">
          <h2 class="h6 mb-2">Последний ответ API</h2>
          <pre class="mb-0">{{ last_response | tojson(indent=2) }}</pre>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      const POLL_INTERVAL_MS = 4000;
      let matchPollTimer = null;

      const responseContainer = document.getElementById("start-game-response");
      const responseDataset =
        responseContainer && responseContainer.dataset ? responseContainer.dataset : null;

      const normalizeId = (value) => {
        if (typeof value !== "string") {
          return null;
        }

        const trimmed = value.trim();
        if (!trimmed) {
          return null;
        }

        const lower = trimmed.toLowerCase();
        if (lower === "none" || lower === "null" || lower === "undefined") {
          return null;
        }

        return trimmed;
      };

      let currentMatchId = normalizeId(responseDataset ? responseDataset.matchId : null);
      const currentUserId = normalizeId(responseDataset ? responseDataset.userId : null);

      const handleJsonResponse = async (response) => {
        let data = null;
        try {
          data = await response.json();
        } catch (_) {}

        if (!response.ok || data === null) {
          const detail = data && data.detail;
          const message =
            (typeof detail === "string" && detail) ||
            (detail && detail.error) ||
            (detail && detail.message) ||
            response.statusText ||
            "Неизвестная ошибка";
          throw new Error(message);
        }

        return data;
      };

      const toJsonPayload = (form) => {
        const formData = new FormData(form);
        const payload = {};
        formData.forEach((value, key) => {
          payload[key] = value;
        });
        return payload;
      };

      const escapeHtml = (value) => {
        if (value === undefined || value === null) {
          return "";
        }
        return String(value).replace(/[&<>"']/g, (char) => {
          switch (char) {
            case "&":
              return "&amp;";
            case "<":
              return "&lt;";
            case ">":
              return "&gt;";
            case '"':
              return "&quot;";
            case "'":
              return "&#39;";
            default:
              return char;
          }
        });
      };

      const startGameForm = document.getElementById("start-game-form");
      const teamIdInput = startGameForm
        ? startGameForm.querySelector('input[name="team_id"]')
        : null;
      const datasetTeamId = normalizeId(responseDataset ? responseDataset.teamId : null);
      const currentTeamId = normalizeId(
        teamIdInput && teamIdInput.value ? teamIdInput.value : datasetTeamId
      );

      const buildGameRedirect = (redirect) => {
        if (typeof redirect !== "string" || !redirect) {
          return redirect;
        }

        try {
          const url = new URL(redirect, window.location.origin);
          if (currentTeamId) {
            url.searchParams.set("team_id", currentTeamId);
          }
          if (currentUserId) {
            url.searchParams.set("user_id", currentUserId);
          }
          return url.toString();
        } catch (_) {
          return redirect;
        }
      };

      const stopPolling = () => {
        if (matchPollTimer) {
          clearInterval(matchPollTimer);
          matchPollTimer = null;
        }
      };

      const renderError = (message) => {
        if (!responseContainer) {
          return;
        }
        responseContainer.innerHTML = `<p class="mb-0 text-danger">${escapeHtml(message)}</p>`;
      };

      const formatTeamName = (team) => {
        if (!team) {
          return escapeHtml("Команда");
        }
        const fallback = team.id ? `Команда ${team.id}` : "Команда";
        return escapeHtml(team.name || fallback);
      };

      const renderWaitingStatus = (container, data) => {
        const teams = Array.isArray(data?.teams) ? data.teams : [];

        if (!teams.length) {
          container.innerHTML = `<p class="mb-0">${escapeHtml(
            "Ожидаем подтверждение готовности команд."
          )}</p>`;
          return;
        }

        const waitingTeams = teams.filter((team) => !team.ready);
        const otherWaitingNames = waitingTeams
          .filter((team) => !currentTeamId || team.id !== currentTeamId)
          .map((team) => formatTeamName(team));

        const isCurrentTeamKnown = teams.some((team) => team.id === currentTeamId);
        const isCurrentTeamReady = teams.some((team) => team.id === currentTeamId && team.ready);

        let introHtml;
        if (isCurrentTeamReady) {
          if (otherWaitingNames.length) {
            introHtml = `${escapeHtml("Ваша команда готова. Ждём ")}${otherWaitingNames.join(", ")}.`;
          } else if (waitingTeams.length) {
            introHtml = escapeHtml("Ваша команда готова. Ждём остальных участников.");
          } else {
            introHtml = escapeHtml("Ваша команда готова. Ожидаем запуск матча.");
          }
        } else if (isCurrentTeamKnown) {
          introHtml = escapeHtml("Подтвердите готовность команды, чтобы начать матч.");
        } else {
          introHtml = escapeHtml("Ожидаем подтверждение готовности команд.");
        }

        const itemsHtml = teams
          .map((team) => {
            const name = formatTeamName(team);
            const statusClass = team.ready ? "text-success" : "text-warning";
            const statusText = team.ready ? "готова ✅" : "ждём подтверждения…";
            const suffix = currentTeamId && team.id === currentTeamId ? " <span class=\"text-muted\">(ваша команда)</span>" : "";
            return `<li class="mb-1"><span class="fw-semibold">${name}</span>${suffix} — <span class="${statusClass}">${escapeHtml(statusText)}</span></li>`;
          })
          .join("");

        container.innerHTML = `
          <p class="mb-2">${introHtml}</p>
          <ul class="list-unstyled mb-0">${itemsHtml}</ul>
        `;
      };

      const renderStartedStatus = (container, data) => {
        const teams = Array.isArray(data?.teams) ? data.teams : [];
        const summary = escapeHtml("Все команды подтвердили готовность. Перенаправляем в игру…");

        if (!teams.length) {
          container.innerHTML = `<p class="mb-0 text-success">${summary}</p>`;
          return;
        }

        const itemsHtml = teams
          .map((team) => {
            const name = formatTeamName(team);
            const suffix = currentTeamId && team.id === currentTeamId ? " <span class=\"text-muted\">(ваша команда)</span>" : "";
            return `<li class="mb-1"><span class="fw-semibold">${name}</span>${suffix}</li>`;
          })
          .join("");

        container.innerHTML = `
          <p class="mb-2 text-success">${summary}</p>
          <ul class="list-unstyled mb-0">${itemsHtml}</ul>
        `;
      };

      const fetchMatchStatus = async (matchId) => {
        const normalizedId = normalizeId(matchId);
        if (!normalizedId) {
          return;
        }

        const pollResponse = await fetch(`/match/status/${encodeURIComponent(normalizedId)}`);
        const pollData = await handleJsonResponse(pollResponse);
        updateMatchStatus(pollData);
      };

      const updateMatchStatus = (data) => {
        if (!responseContainer) {
          return;
        }

        if (!data || typeof data !== "object") {
          renderError("Неожиданный ответ сервера.");
          return;
        }

        const status = data.status;
        if (status === "waiting") {
          renderWaitingStatus(responseContainer, data);
          const nextMatchId = normalizeId(data.match_id);
          if (nextMatchId) {
            if (currentMatchId !== nextMatchId) {
              currentMatchId = nextMatchId;
              stopPolling();
            }
            if (!matchPollTimer) {
              matchPollTimer = setInterval(() => {
                fetchMatchStatus(currentMatchId).catch((error) => {
                  console.error("Failed to poll match status", error);
                });
              }, POLL_INTERVAL_MS);
            }
          }
        } else if (status === "ready" && data.redirect) {
          // 👇 добавленный блок
          responseContainer.innerHTML = `<p class="mb-0 text-success">Все команды готовы. Переходим к игре…</p>`;
          stopPolling();
          setTimeout(() => {
            window.location.href = buildGameRedirect(data.redirect);
          }, 500);
        } else if (status === "started") {
          renderStartedStatus(responseContainer, data);
          stopPolling();

          if (typeof data.redirect === "string" && data.redirect) {
            setTimeout(() => {
              window.location.href = buildGameRedirect(data.redirect);
            }, 400);
          }
        } else {
          responseContainer.textContent = JSON.stringify(data, null, 2);
        }
      };

      const initialStatusRaw = responseContainer && responseContainer.dataset
        ? responseContainer.dataset.initialStatus
        : null;
      if (initialStatusRaw) {
        try {
          const initialStatus = JSON.parse(initialStatusRaw);
          updateMatchStatus(initialStatus);
        } catch (error) {
          console.warn("Failed to parse initial match status", error);
        }
        delete responseContainer.dataset.initialStatus;
      }

      if (responseContainer && !initialStatusRaw && currentMatchId) {
        fetchMatchStatus(currentMatchId).catch((error) => {
          console.error("Failed to fetch initial match status", error);
        });
      }

      if (startGameForm && responseContainer) {
        startGameForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          stopPolling();
          responseContainer.textContent = "Отправка запроса…";

          const payload = toJsonPayload(startGameForm);

          try {
            const fetchResponse = await fetch(startGameForm.action, {
              method: startGameForm.method.toUpperCase(),
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const data = await handleJsonResponse(fetchResponse);
            updateMatchStatus(data);
          } catch (error) {
            renderError(error.message || String(error));
          }
        });
      }

      const leaveTeamForm = document.getElementById("leave-team-form");
      if (leaveTeamForm) {
        leaveTeamForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!confirm("Вы уверены, что хотите покинуть команду?")) {
            return;
          }

          const payload = toJsonPayload(leaveTeamForm);

          try {
            const response = await fetch(leaveTeamForm.action, {
              method: leaveTeamForm.method.toUpperCase(),
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const data = await handleJsonResponse(response);
            alert(data.message || "Вы покинули команду.");
            window.location.href = data.redirect || "/";
          } catch (error) {
            alert("Не удалось выйти из команды: " + (error.message || error));
          }
        });
      }

      const deleteTeamForm = document.getElementById("delete-team-form");
      if (deleteTeamForm) {
        deleteTeamForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!confirm("Удалить команду без возможности восстановления?")) {
            return;
          }

          const payload = toJsonPayload(deleteTeamForm);

          try {
            const response = await fetch(deleteTeamForm.action, {
              method: deleteTeamForm.method.toUpperCase(),
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const data = await handleJsonResponse(response);
            alert(data.message || "Команда удалена.");
            window.location.href = data.redirect || "/";
          } catch (error) {
            alert("Не удалось удалить команду: " + (error.message || error));
          }
        });
      }
    })();
  </script>
{% endblock %}