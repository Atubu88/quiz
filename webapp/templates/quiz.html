{% extends "base.html" %}

{% block title %}Игра · Командная Викторина{% endblock %}

{% block content %}
  {% set question = question or {} %}
  {% set options = question.options or answers or [] %}
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h1 class="h3 mb-3">Текущий вопрос</h1>
          {% if question.text %}
            <p class="fs-5">{{ question.text }}</p>
            <div class="list-group" id="answer-options">
              {% for option in options %}
                <button
                  type="button"
                  class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                  data-answer-id="{{ option.id or loop.index0 }}"
                >
                  <span>{{ option.text or option.title }}</span>
                  <span class="badge text-bg-secondary">Выбрать</span>
                </button>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted mb-0">Вопросы не загружены. Используйте API, чтобы начать игру.</p>
          {% endif %}
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h5 mb-3">Ответ API</h2>
          <pre class="bg-dark text-white p-3 rounded" id="answer-response">Ожидание запроса…</pre>
          <div class="mt-3" id="explanation-wrapper" hidden>
            <h3 class="h6 text-muted">Объяснение</h3>
            <p id="answer-explanation" class="mb-0"></p>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5 mb-3">Следующий шаг</h2>
          <form id="next-question-form" action="/game/next" method="post">
            <input type="hidden" name="game_id" value="{{ game_id }}" />
            <button type="submit" class="btn btn-outline-primary" id="next-question-button" disabled>
              Следующий вопрос
            </button>
          </form>
          <div class="mt-3">
            <h3 class="h6 text-muted">Ответ сервера</h3>
            <pre class="bg-dark text-white p-3 rounded" id="next-question-response">Ожидание запроса…</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    const answerList = document.getElementById("answer-options");
    const answerResponse = document.getElementById("answer-response");
    const explanationWrapper = document.getElementById("explanation-wrapper");
    const explanationText = document.getElementById("answer-explanation");
    const nextQuestionButton = document.getElementById("next-question-button");

    const questionPayload = {{ {"question_id": question.id if question and (question.id is not none) else None}|tojson }};

    if (answerList) {
      answerList.addEventListener("click", async (event) => {
        const target = event.target.closest("[data-answer-id]");
        if (!target) return;

        const answerId = target.getAttribute("data-answer-id");
        answerResponse.textContent = "Отправка ответа…";
        explanationWrapper.hidden = true;
        explanationText.textContent = "";

        try {
          const fetchResponse = await fetch("/game/answer", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ...questionPayload,
              answer_id: answerId,
            }),
          });

          const data = await fetchResponse.json();
          answerResponse.textContent = JSON.stringify(data, null, 2);

          if (data && data.explanation) {
            explanationWrapper.hidden = false;
            explanationText.textContent = data.explanation;
          }

          if (nextQuestionButton) {
            nextQuestionButton.disabled = false;
          }
        } catch (error) {
          answerResponse.textContent = `Ошибка: ${error}`;
        }
      });
    }

    const nextQuestionForm = document.getElementById("next-question-form");
    const nextQuestionResponse = document.getElementById("next-question-response");

    if (nextQuestionForm && nextQuestionResponse) {
      nextQuestionForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        nextQuestionResponse.textContent = "Запрос отправляется…";

        const formData = new FormData(nextQuestionForm);
        const payload = {};
        formData.forEach((value, key) => {
          if (value) {
            payload[key] = value;
          }
        });

        try {
          const fetchResponse = await fetch(nextQuestionForm.action, {
            method: nextQuestionForm.method.toUpperCase(),
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const data = await fetchResponse.json();
          nextQuestionResponse.textContent = JSON.stringify(data, null, 2);
          nextQuestionButton.disabled = true;
        } catch (error) {
          nextQuestionResponse.textContent = `Ошибка: ${error}`;
        }
      });
    }
  </script>
{% endblock %}
