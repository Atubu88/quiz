{% extends "base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è ¬∑ –ö–æ–º–∞–Ω–¥–Ω–∞—è –í–∏–∫—Ç–æ—Ä–∏–Ω–∞{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="text-center mb-5">
        <h1 class="display-5 fw-bold">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥–Ω—É—é –í–∏–∫—Ç–æ—Ä–∏–Ω—É!</h1>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h4 mb-3">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</h2>
          <form id="create-team-form" action="/team/create" method="post" novalidate>
            <div class="mb-3">
              <label for="team-name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã</label>
              <input type="text" class="form-control" id="team-name" name="team_name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ú–æ–∑–≥–æ–≤–æ–π —à—Ç—É—Ä–º" required />
            </div>
            <div class="mb-3">
              <label for="create-user" class="form-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
              <input type="number" class="form-control" id="create-user" name="user_id" placeholder="–í–≤–µ–¥–∏—Ç–µ ID" required />
            </div>
            <button type="submit" class="btn btn-success">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
          </form>
          <div class="mt-3">
            <h3 class="h6 text-muted">–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</h3>
            <pre class="bg-dark text-white p-3 rounded" id="create-team-response">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞‚Ä¶</pre>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h4 mb-3">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–∞–Ω–¥–µ</h2>
          <form id="join-team-form" action="/team/join" method="post" novalidate>
            <div class="mb-3">
              <label for="join-user" class="form-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
              <input type="number" class="form-control" id="join-user" name="user_id" placeholder="–í–≤–µ–¥–∏—Ç–µ ID" required />
            </div>
            <div class="mb-3">
              <label for="join-code" class="form-label">–ö–æ–¥ –∫–æ–º–∞–Ω–¥—ã</label>
              <input type="text" class="form-control" id="join-code" name="code" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" required />
            </div>
            <button type="submit" class="btn btn-primary">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
          </form>
          <div class="mt-3">
            <h3 class="h6 text-muted">–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</h3>
            <pre class="bg-dark text-white p-3 rounded" id="join-team-response">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞‚Ä¶</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    // —Å—Ä–∞–∑—É –ª–æ–≥–∏–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –≤—Ö–æ–¥–µ
    if (tg.initData) {
      fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData: tg.initData })
      })
      .then(r => r.json())
      .then(data => {
        console.log("Login response:", data);
        const header = document.querySelector("h1.display-5");
        if (data.user && data.user.first_name) {
          header.textContent = `–ü—Ä–∏–≤–µ—Ç, ${data.user.first_name}! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –í–∏–∫—Ç–æ—Ä–∏–Ω—É üéâ`;
        }
      })
      .catch(err => console.error("Login error:", err));
    } else {
      console.warn("–ù–µ—Ç tg.initData ‚Äî –ø—Ä–æ–≤–µ—Ä—è–π –∑–∞–ø—É—Å–∫ –∏–∑ Telegram Mini App");
    }

    // --- —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ---
    const handleFormSubmit = (formId, responseId) => {
      const form = document.getElementById(formId);
      const responseContainer = document.getElementById(responseId);

      if (!form || !responseContainer) return;

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        responseContainer.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞‚Ä¶";

        const formData = new FormData(form);
        const payload = {};
        formData.forEach((value, key) => {
          payload[key] = value;
        });

        try {
          const fetchResponse = await fetch(form.action, {
            method: form.method.toUpperCase(),
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const data = await fetchResponse.json();
          responseContainer.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          responseContainer.textContent = `–û—à–∏–±–∫–∞: ${error}`;
        }
      });
    };

    handleFormSubmit("create-team-form", "create-team-response");
    handleFormSubmit("join-team-form", "join-team-response");
  </script>
{% endblock %}
