{% extends "base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è ¬∑ –ö–æ–º–∞–Ω–¥–Ω–∞—è –í–∏–∫—Ç–æ—Ä–∏–Ω–∞{% endblock %}

{% block content %}
  {% set user = user or {} %}
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="text-center mb-5">
        <h1 class="display-5 fw-bold">
          {% if user.display_name %}
            –ü—Ä–∏–≤–µ—Ç, {{ user.display_name }}! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –í–∏–∫—Ç–æ—Ä–∏–Ω—É üéâ
          {% else %}
            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥–Ω—É—é –í–∏–∫—Ç–æ—Ä–∏–Ω—É!
          {% endif %}
        </h1>
        <p class="text-muted mb-0">–ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram, —á—Ç–æ–±—ã –º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∞—Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª–∏.</p>
      </div>

      {% if status_message %}
        <div class="alert alert-success" role="alert">
          {{ status_message }}
        </div>
      {% endif %}

      {% if not user %}
        <div class="alert alert-warning" role="alert">
          –ú—ã –Ω–µ —Å–º–æ–≥–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ initData –≤—Ä—É—á–Ω—É—é.
        </div>
      {% endif %}

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h4 mb-3">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</h2>
          <form action="/team/create" method="post">
            <div class="mb-3">
              <label for="team-name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã</label>
              <input type="text" class="form-control" id="team-name" name="team_name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ú–æ–∑–≥–æ–≤–æ–π —à—Ç—É—Ä–º" required />
            </div>
            <div class="mb-3">
              <label for="create-user" class="form-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
              <input type="number" class="form-control" id="create-user" name="user_id" value="{{ prefill_user_id or '' }}" placeholder="–í–≤–µ–¥–∏—Ç–µ ID" required />
            </div>
            <button type="submit" class="btn btn-success" {% if not prefill_user_id %}disabled{% endif %}>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
          </form>
          {% if not prefill_user_id %}
            <p class="text-muted small mb-0 mt-2">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram.</p>
          {% endif %}
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h4 mb-3">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–∞–Ω–¥–µ</h2>
          <form action="/team/join" method="post">
            <div class="mb-3">
              <label for="join-user" class="form-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
              <input type="number" class="form-control" id="join-user" name="user_id" value="{{ prefill_user_id or '' }}" placeholder="–í–≤–µ–¥–∏—Ç–µ ID" required />
            </div>
            <div class="mb-3">
              <label for="join-code" class="form-label">–ö–æ–¥ –∫–æ–º–∞–Ω–¥—ã</label>
              <input type="text" class="form-control" id="join-code" name="code" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" required />
            </div>
            <button type="submit" class="btn btn-primary" {% if not prefill_user_id %}disabled{% endif %}>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <form id="login-form" action="/login" method="post" class="d-none">
    <input type="hidden" name="init_data" id="init-data-field" />
  </form>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const existingUser = {{ user|default({})|tojson }};
    const loginForm = document.getElementById("login-form");
    const initDataField = document.getElementById("init-data-field");

    if ((!existingUser || Object.keys(existingUser).length === 0) && tg.initData) {
      initDataField.value = tg.initData;
      loginForm.submit();
    }
  </script>
{% endblock %}
