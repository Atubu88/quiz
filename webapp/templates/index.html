{% extends "base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è ¬∑ –ö–æ–º–∞–Ω–¥–Ω–∞—è –í–∏–∫—Ç–æ—Ä–∏–Ω–∞{% endblock %}

{% block content %}
  <div class="text-center mt-5">
    <h1 class="display-5 fw-bold mb-4">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ö–æ–º–∞–Ω–¥–Ω—É—é –í–∏–∫—Ç–æ—Ä–∏–Ω—É üéâ</h1>

    <div class="d-grid gap-3 col-6 mx-auto">
      <button id="btn-create" class="btn btn-success btn-lg">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
      <button id="btn-join" class="btn btn-primary btn-lg">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –∫–æ–º–∞–Ω–¥–µ</button>
      <!-- üî¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞ -->
      <a id="btn-myteam" href="#" class="btn btn-info btn-lg" style="display:none;">–ú–æ—è –∫–æ–º–∞–Ω–¥–∞</a>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    let currentUser = null;
    let currentTeam = null;

    const btnCreate = document.getElementById("btn-create");
    const btnJoin = document.getElementById("btn-join");
    const myTeamBtn = document.getElementById("btn-myteam");

    // ===== –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è =====
    if (tg.initData) {
      fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData: tg.initData })
      })
      .then(r => r.json())
      .then(async data => {
        currentUser = data.user;

        // –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –∫–æ–º–∞–Ω–¥–∞
        try {
          const resp = await fetch(`/team/of-user/${currentUser.id}`);
          if (resp.ok) {
            const team = await resp.json();
            if (team && team.id) {
              currentTeam = team;
              myTeamBtn.href = `/team/${team.id}?user_id=${currentUser.id}`;
              myTeamBtn.style.display = "block"; // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            } else {
              myTeamBtn.style.display = "none"; // —Å–∫—Ä—ã—Ç–∞, –µ—Å–ª–∏ –∫–æ–º–∞–Ω–¥—ã –Ω–µ—Ç
            }
          }
        } catch (err) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–∞–Ω–¥—É:", err);
          myTeamBtn.style.display = "none";
        }
      })
      .catch(err => console.error("Login error:", err));
    }

    // ===== –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ =====
    const handleJsonResponse = async (response) => {
      let data = null;
      try { data = await response.json(); } catch (_) {}
      if (!response.ok || !data) {
        const detail = data && data.detail;
        const message =
          (typeof detail === "string" && detail) ||
          (detail && detail.error) ||
          (detail && detail.message) ||
          response.statusText ||
          "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
        throw new Error(message);
      }
      return data;
    };

    const redirectToTeam = (payload) => {
      const redirectPath =
        payload.redirect ||
        (payload.team && payload.team.id ? `/team/${payload.team.id}` : null);

      if (!redirectPath) throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞");

      const url = new URL(redirectPath, window.location.origin);
      if (currentUser && currentUser.id && !url.searchParams.has("user_id")) {
        url.searchParams.set("user_id", currentUser.id);
      }
      window.location.href = url.toString();
    };

    // ===== –°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É =====
    btnCreate.onclick = () => {
      if (!currentUser) return alert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
      if (currentTeam) return alert("–£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –∫–æ–º–∞–Ω–¥–∞. –°–Ω–∞—á–∞–ª–∞ –≤—ã–π–¥–∏ –∏–∑ –Ω–µ—ë –∏–ª–∏ –≤–æ–π–¥–∏ –≤ —Å–≤–æ—é.");

      const teamName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:");
      if (!teamName) return;

      fetch("/team/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: currentUser.id, team_name: teamName })
      })
      .then(handleJsonResponse)
      .then(redirectToTeam)
      .catch(err => alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã: " + err.message));
    };

    // ===== –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –∫–æ–º–∞–Ω–¥–µ =====
    btnJoin.onclick = () => {
      if (!currentUser) return alert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
      if (currentTeam) return alert("–£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –∫–æ–º–∞–Ω–¥–∞. –°–Ω–∞—á–∞–ª–∞ –≤—ã–π–¥–∏ –∏–∑ –Ω–µ—ë –∏–ª–∏ –≤–æ–π–¥–∏ –≤ —Å–≤–æ—é.");

      const code = prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–∞–Ω–¥—ã:");
      if (!code) return;

      fetch("/team/join", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: currentUser.id, code })
      })
      .then(handleJsonResponse)
      .then(redirectToTeam)
      .catch(err => alert("–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + err.message));
    };
  </script>
{% endblock %}




